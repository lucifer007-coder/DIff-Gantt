<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diff‑Gantt — Dataset Version Comparison</title>
  <style>
    :root{
      --bg-1:#ffffff;--bg-2:#f6f7f9;--bg-3:#e9edf3;--text-1:#1f2328;--text-2:#6b7280;--border:#d0d7de;--accent:#3b82f6;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;--ins:#22c55e;--upd:#f59e0b;--del:#ef4444
    }
    @media (prefers-color-scheme:dark){:root{--bg-1:#0b0f14;--bg-2:#0f1520;--bg-3:#172033;--text-1:#e5e7eb;--text-2:#a3aab8;--border:#263248;--accent:#60a5fa;--ok:#4ade80;--warn:#fbbf24;--bad:#f87171;--ins:#4ade80;--upd:#fbbf24;--del:#f87171}}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,"Helvetica Neue",Arial;line-height:1.5;background:var(--bg-1);color:var(--text-1)}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    header{margin:8px 0 20px;text-align:center}
    header h1{margin:0 0 6px;font-size:clamp(22px,2.8vw,32px);color:var(--accent)}
    header p{margin:0;color:var(--text-2)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    .grid{display:grid;gap:16px;grid-template-columns:1fr 1fr}
    @media (max-width:840px){.grid{grid-template-columns:1fr}}

    .card{background:var(--bg-2);border:1px solid var(--border);border-radius:12px;padding:18px}
    .upload{position:relative;border:2px dashed var(--border);border-radius:12px;padding:26px;text-align:center;background:var(--bg-3);cursor:pointer;transition:.2s}
    .upload:hover,.upload:focus-within{border-color:var(--accent)}
    .upload.dragover{transform:scale(1.01);border-color:var(--accent)}
    .upload h3{margin:0 0 6px}
    .upload p{margin:0 0 8px;color:var(--text-2)}
    .upload .fileinput{position:absolute;inset:0;opacity:0;cursor:pointer}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;background:var(--accent);color:#fff;font-weight:600;cursor:pointer;transition:.15s}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn:hover:not([disabled]){opacity:.95;transform:translateY(-1px)}

    .config{display:none}
    .config .row{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    label{font-weight:600}
    select{width:100%;padding:9px 10px;border:1px solid var(--border);border-radius:8px;background:var(--bg-1);color:var(--text-1)}

    .alert{border-radius:10px;padding:12px 14px;margin:10px 0}
    .alert.error{background:rgba(239,68,68,.12);border:1px solid var(--bad);color:var(--bad)}
    .alert.success{background:rgba(34,197,94,.12);border:1px solid var(--ok);color:var(--ok)}

    .stats{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));margin:16px 0}
    .stat{background:var(--bg-2);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center}
    .num{font-size:28px;font-weight:800}
    .num.ins{color:var(--ins)}.num.upd{color:var(--upd)}.num.del{color:var(--del)}

    .gantt-wrap{background:var(--bg-2);border:1px solid var(--border);border-radius:12px;padding:12px}
    .gantt-head{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:8px}
    .legend{display:flex;gap:12px;flex-wrap:wrap}
    .legend span{display:inline-flex;gap:8px;align-items:center}
    .dot{width:14px;height:14px;border-radius:3px;display:inline-block}
    .dot.ins{background:var(--ins)}.dot.upd{background:var(--upd)}.dot.del{background:var(--del)}
    canvas{display:block;width:100%;border:1px solid var(--border);border-radius:8px}

    .drawer{position:fixed;top:0;right:-420px;width:420px;max-width:100vw;height:100vh;background:var(--bg-1);border-left:1px solid var(--border);box-shadow:-8px 0 24px rgba(0,0,0,.15);transition:right .25s ease;z-index:60;display:flex;flex-direction:column}
    .drawer.open{right:0}
    .drawer-head{position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border);background:var(--bg-1)}
    .drawer-body{padding:12px 14px;overflow:auto}
    .x{background:none;border:0;font-size:24px;line-height:1;cursor:pointer;color:var(--text-1)}

    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid var(--border);padding:8px 10px;text-align:left;word-break:break-word}
    th{background:var(--bg-2)}
    .added{background:rgba(34,197,94,.1)}
    .removed{background:rgba(239,68,68,.1)}
    .changed{background:rgba(245,158,11,.11)}

    .loading{display:none;text-align:center;color:var(--text-2)}
    .spinner{width:28px;height:28px;border-radius:50%;border:3px solid var(--border);border-top-color:var(--accent);margin:10px auto;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Diff‑Gantt</h1>
      <p>Visualize row‑level changes between two CSV versions</p>
    </header>

    <div id="alerts" aria-live="polite"></div>

    <section class="grid" aria-label="Upload CSV files">
      <div class="card">
        <div id="oldArea" class="upload" tabindex="0" role="button" aria-label="Upload old dataset">
          <h3>Old Dataset</h3>
          <p>Drop CSV here or click to browse</p>
          <button class="btn" type="button">Choose File</button>
          <input id="oldInput" class="fileinput" type="file" accept=".csv" />
          <div id="oldInfo" style="margin-top:8px;display:none"></div>
        </div>
      </div>
      <div class="card">
        <div id="newArea" class="upload" tabindex="0" role="button" aria-label="Upload new dataset">
          <h3>New Dataset</h3>
          <p>Drop CSV here or click to browse</p>
          <button class="btn" type="button">Choose File</button>
          <input id="newInput" class="fileinput" type="file" accept=".csv" />
          <div id="newInfo" style="margin-top:8px;display:none"></div>
        </div>
      </div>
    </section>

    <section id="config" class="card config" aria-label="Configuration">
      <h3 style="margin-top:0">Configuration</h3>
      <div class="row" style="margin-top:10px">
        <div>
          <label for="pkSelect">Primary Key Column *</label>
          <select id="pkSelect"><option value="">Select primary key…</option></select>
        </div>
        <div>
          <label for="tsSelect">Timestamp Column (optional)</label>
          <select id="tsSelect"><option value="">Select timestamp…</option></select>
        </div>
        <div style="display:flex;align-items:end">
          <button id="go" class="btn" type="button">Generate Diff</button>
        </div>
      </div>
    </section>

    <div id="loading" class="loading" role="status" aria-live="polite">
      <div class="spinner"></div>
      <div>Processing datasets…</div>
    </div>

    <section id="results" style="display:none">
      <div class="stats">
        <div class="stat"><div id="insCount" class="num ins">0</div><div>Inserted</div></div>
        <div class="stat"><div id="updCount" class="num upd">0</div><div>Updated</div></div>
        <div class="stat"><div id="delCount" class="num del">0</div><div>Deleted</div></div>
      </div>

      <div class="gantt-wrap">
        <div class="gantt-head">
          <h3 style="margin:0">Timeline Visualization</h3>
          <div class="legend">
            <span><i class="dot ins"></i> Insert</span>
            <span><i class="dot upd"></i> Update</span>
            <span><i class="dot del"></i> Delete</span>
          </div>
        </div>
        <canvas id="gantt" aria-label="Gantt chart of changes" role="img"></canvas>
      </div>
    </section>
  </div>

  <div id="drawer" class="drawer" role="dialog" aria-labelledby="drawerTitle" aria-hidden="true">
    <div class="drawer-head">
      <h3 id="drawerTitle" style="margin:0">Row Details</h3>
      <button id="closeDrawer" class="x" aria-label="Close details">×</button>
    </div>
    <div id="drawerBody" class="drawer-body"></div>
  </div>

  <script>
  (()=>{
    'use strict';
    /** Utilities **/
    const $ = (id)=>document.getElementById(id);
    const escapeHtml=(str)=>{const d=document.createElement('div');d.textContent=String(str);return d.innerHTML};
    const fileSize=(b)=>{if(!b) return '0 B';const k=1024,u=['B','KB','MB','GB'];const i=Math.min(u.length-1,Math.floor(Math.log(b)/Math.log(k)));return `${(b/Math.pow(k,i)).toFixed(2)} ${u[i]}`};

    function alertBox(type,msg){const host=$('alerts');host.innerHTML=`<div class="alert ${type}">${escapeHtml(msg)}</div>`;setTimeout(()=>{if(host.textContent?.includes(msg)) host.innerHTML='';},5000)}

    /** CSV Parser (robust enough for quoted values + escaped quotes) **/
    function splitCSVLine(line){
      const out=[];let cur='';let q=false;for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(ch==='"'){
          if(q && line[i+1]==='"'){cur+='"';i++;} else {q=!q;}
        } else if(ch===',' && !q){out.push(cur);cur='';}
        else if(ch==='\r'){/* ignore */}
        else {cur+=ch;}
      }
      out.push(cur);
      return out;
    }

    function parseCSV(text, filename){
      if(!text || !text.trim()) throw new Error('CSV file is empty');
      // Normalize newlines and keep blank trailing fields; ignore purely empty rows
      const rows = text.replace(/\uFEFF/g,'').split(/\n/).filter(r=>r.trim().length>0);
      const headers = splitCSVLine(rows[0]).map(h=>h.trim());
      if(headers.length===0) throw new Error('No headers found');
      const seen = new Set();
      for(const h of headers){if(seen.has(h)) throw new Error(`Duplicate header: ${h}`); seen.add(h)}
      const data=[];
      for(let i=1;i<rows.length;i++){
        const vals = splitCSVLine(rows[i]);
        if(vals.length!==headers.length){console.warn(`Row ${i+1}: expected ${headers.length} columns, got ${vals.length}`);continue}
        const row={};
        for(let c=0;c<headers.length;c++){row[headers[c]] = vals[c]===undefined ? '' : vals[c];}
        data.push(row);
      }
      if(data.length===0) throw new Error('No valid data rows found');
      return {headers, data, filename};
    }

    /** Diff + validation **/
    function ensureUniquePK(rows, pk, label){
      const set=new Set(); const dups=new Set(); let missing=false;
      for(const r of rows){
        const k=r[pk];
        if(k===undefined || k===null || String(k).trim()==='') {missing=true; continue}
        const s=String(k);
        if(set.has(s)) dups.add(s); else set.add(s);
      }
      if(missing) throw new Error(`Missing/blank primary key values in ${label}`);
      if(dups.size>0) throw new Error(`Duplicate primary keys in ${label}: ${[...dups].slice(0,5).join(', ')}${dups.size>5?'…':''}`);
    }

    function parseMaybeDate(v){
      if(v===undefined||v===null) return null;
      const s=String(v).trim();
      if(!s) return null;
      if(/^\d{13}$/.test(s)) { const d=new Date(parseInt(s,10)); return isNaN(d.getTime())?null:d; }
      if(/^\d{10}$/.test(s)) { const d=new Date(parseInt(s,10)*1000); return isNaN(d.getTime())?null:d; }
      const d=new Date(s); return isNaN(d.getTime())?null:d;
    }

    function diff(oldD,newD,pk,tsCol){
      const oldMap=new Map(), newMap=new Map();
      oldD.data.forEach(r=>oldMap.set(String(r[pk]),r));
      newD.data.forEach(r=>newMap.set(String(r[pk]),r));

      const res={inserts:[],updates:[],deletes:[],primaryKey:pk,timestampCol:tsCol||'',useOrdinalTime:false};
      const items=[]; // collect to test timestamp quality

      newMap.forEach((nRow,key)=>{
        const oRow=oldMap.get(key);
        if(!oRow){
          const ts = tsCol ? parseMaybeDate(nRow[tsCol]) : null;
          const item={key,timestamp:ts,data:nRow,type:'insert'}; res.inserts.push(item); items.push(item);
        } else {
          // Ignore PK and timestamp column when computing changes
          const changes=[]; const skip=new Set([pk, tsCol].filter(Boolean));
          const allCols = new Set([...Object.keys(oRow),...Object.keys(nRow)]);
          allCols.forEach(col=>{ if(skip.has(col)) return; const a=oRow[col]??''; const b=nRow[col]??''; if(a!==b) changes.push({column:col,oldValue:a,newValue:b}); });
          if(changes.length){
            const ts = tsCol ? parseMaybeDate(nRow[tsCol]) : null;
            const item={key,timestamp:ts,oldData:oRow,newData:nRow,changes,type:'update'}; res.updates.push(item); items.push(item);
          }
        }
      });
      oldMap.forEach((oRow,key)=>{ if(!newMap.has(key)){ const ts = tsCol ? parseMaybeDate(oRow[tsCol]) : null; const item={key,timestamp:ts,data:oRow,type:'delete'}; res.deletes.push(item); items.push(item);} });

      // Decide whether to use real timestamps or ordinal positions
      if(!tsCol){ res.useOrdinalTime=true; }
      else {
        const valid = items.filter(i=>i.timestamp instanceof Date && !isNaN(i.timestamp));
        const ratio = items.length ? valid.length/items.length : 1;
        if(ratio<0.8){ // too many bad timestamps; fall back to ordinal
          res.useOrdinalTime=true;
          items.forEach(i=>i.timestamp=null);
        }
      }

      // Assign ordinal index for charting if needed (stable ordering: by type then by PK)
      if(res.useOrdinalTime){
        const ordered=[...res.deletes,...res.updates,...res.inserts]; // any stable order
        ordered.forEach((it,idx)=>{it._ord=idx});
      }
      return res;
    }

    /** Gantt Chart **/
    class Gantt{
      constructor(canvas,data,{onClick}={}){
        this.canvas=canvas; this.ctx=canvas.getContext('2d'); this.data=data; this.onClick=onClick;
        this.items=[]; this.padding={top:40,right:40,bottom:60,left:140}; this.barH=20; this.gap=6; this.ratio=window.devicePixelRatio||1;
        this.colors={insert:getComputedStyle(document.documentElement).getPropertyValue('--ins').trim()||'#22c55e',update:getComputedStyle(document.documentElement).getPropertyValue('--upd').trim()||'#f59e0b',delete:getComputedStyle(document.documentElement).getPropertyValue('--del').trim()||'#ef4444'};
        this._click=null; this._prepare(); this._listen(); this.resize();
      }
      _prepare(){
        const all=[]; ['inserts','updates','deletes'].forEach(t=>{(this.data[t]||[]).forEach(it=>all.push({...it}))});
        if(!this.data.useOrdinalTime){all.sort((a,b)=>a.timestamp-b.timestamp)} else {all.sort((a,b)=>a._ord-b._ord)}
        this.items=all; this._groupByKey(); this._computeTime();
      }
      _groupByKey(){
        const groups={}; this.items.forEach(it=>{const k=String(it.key); (groups[k]||(groups[k]=[])).push(it)});
        this.keys=Object.keys(groups).sort(); this.groups=groups;
      }
      _computeTime(){
        if(this.data.useOrdinalTime){ this.min=0; this.max=Math.max(1,(this.items.length-1)); this.range=this.max-this.min; return; }
        const times=this.items.map(i=>i.timestamp?.getTime()).filter(t=>typeof t==='number' && !isNaN(t));
        this.min=Math.min(...times); this.max=Math.max(...times); this.range=Math.max(1,this.max-this.min);
      }
      _listen(){
        this._click=(e)=>{
          const rect=this.canvas.getBoundingClientRect();
          const x=(e.clientX-rect.left)*this.ratio; const y=(e.clientY-rect.top)*this.ratio; const hit=this._hit(x,y);
          if(hit && this.onClick) this.onClick(hit);
        };
        this.canvas.addEventListener('click',this._click);
      }
      cleanup(){ if(this._click){ this.canvas.removeEventListener('click',this._click); this._click=null; } }
      resize(){
        const parent=this.canvas.parentElement; if(!parent) return; const rect=parent.getBoundingClientRect();
        const cssW=Math.max(320,rect.width-2); const cssH=Math.max(380, this.keys.length*(this.barH+this.gap)+this.padding.top+this.padding.bottom);
        this.canvas.style.width=cssW+'px'; this.canvas.style.height=cssH+'px';
        // reset transform before resizing to avoid compounding scales
        this.ctx.setTransform(1,0,0,1,0,0);
        this.canvas.width=Math.floor(cssW*this.ratio); this.canvas.height=Math.floor(cssH*this.ratio);
        this.ctx.scale(this.ratio,this.ratio);
        this.render();
      }
      render(){
        const w=this.canvas.width/this.ratio, h=this.canvas.height/this.ratio; const ctx=this.ctx;
        ctx.clearRect(0,0,w,h);
        if(this.items.length===0){ ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--text-2'); ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font='16px Inter,ui-sans-serif'; ctx.fillText('No changes to display',w/2,h/2); return; }
        this._axes(w,h); this._bars(w,h);
      }
      _axes(w,h){
        const ctx=this.ctx; const text=getComputedStyle(document.documentElement).getPropertyValue('--text-1').trim(); const border=getComputedStyle(document.documentElement).getPropertyValue('--border').trim();
        ctx.strokeStyle=border; ctx.fillStyle=text; ctx.font='12px Inter,ui-sans-serif';
        // y labels
        ctx.textAlign='right'; ctx.textBaseline='middle';
        this.keys.forEach((k,i)=>{const y=this.padding.top+i*(this.barH+this.gap)+this.barH/2; const lab=String(k).length>18?String(k).slice(0,15)+'…':String(k); ctx.fillText(lab,this.padding.left-10,y)});
        // x labels
        ctx.textAlign='center'; ctx.textBaseline='top';
        const steps=Math.min(6, Math.max(3,this.items.length)); const chartW=w-this.padding.left-this.padding.right;
        for(let i=0;i<=steps;i++){
          const t=this.min + (this.range * i/steps);
          const x=this.padding.left + chartW * (i/steps);
          let label='';
          if(this.data.useOrdinalTime){ label = `#${Math.round(t)+1}`; }
          else { const d=new Date(t); label = (this.range<86400000)? d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : d.toLocaleDateString(); }
          ctx.fillText(label, x, h - this.padding.bottom + 8);
        }
        // axes lines
        ctx.beginPath(); ctx.moveTo(this.padding.left,this.padding.top); ctx.lineTo(this.padding.left,h-this.padding.bottom); ctx.moveTo(this.padding.left,h-this.padding.bottom); ctx.lineTo(w-this.padding.right,h-this.padding.bottom); ctx.stroke();
      }
      _bars(w,h){
        const ctx=this.ctx; const chartW=w-this.padding.left-this.padding.right; if(chartW<=0) return;
        this.items.forEach(it=>{
          const i=this.keys.indexOf(String(it.key)); if(i<0) return; const y=this.padding.top+i*(this.barH+this.gap);
          let x=this.padding.left; if(this.data.useOrdinalTime){ const frac=(it._ord - this.min)/(this.range||1); x=this.padding.left + frac*chartW; } else { const frac=((it.timestamp?.getTime?.()??this.min) - this.min)/(this.range||1); x=this.padding.left + frac*chartW; }
          const bw=Math.max(6, Math.min(22, chartW/Math.max(this.items.length,10))); const drawX=Math.max(this.padding.left, Math.min(x-bw/2, w-this.padding.right-bw));
          const color = this.colors[it.type] || '#999';
          ctx.fillStyle=color; ctx.fillRect(drawX,y,bw,this.barH);
          it._bounds = {x:drawX*this.ratio, y:y*this.ratio, w:bw*this.ratio, h:this.barH*this.ratio};
        });
      }
      _hit(x,y){ return this.items.find(it=>{const b=it._bounds; return b && x>=b.x && x<=b.x+b.w && y>=b.y && y<=b.y+b.h}); }
    }

    /** App **/
    class App{
      constructor(){
        this.cfg={maxSize:10*1024*1024};
        this.old=null; this.new=null; this.result=null; this.chart=null; this.resizeObs=null;
        this._bind(); this._dragDrop('oldArea','oldInput','old'); this._dragDrop('newArea','newInput','new');
        $('closeDrawer').addEventListener('click',()=>this._closeDrawer());
        document.addEventListener('keydown',e=>{if(e.key==='Escape') this._closeDrawer();});
      }
      _bind(){
        $('oldArea').addEventListener('click',()=>$('oldInput').click());
        $('newArea').addEventListener('click',()=>$('newInput').click());
        $('oldInput').addEventListener('change',e=>this._handleFile(e.target.files[0],'old'));
        $('newInput').addEventListener('change',e=>this._handleFile(e.target.files[0],'new'));
        $('go').addEventListener('click',()=>this._go());
      }
      _dragDrop(areaId,inputId,label){
        const area=$(areaId), input=$(inputId);
        ['dragenter','dragover'].forEach(ev=>area.addEventListener(ev,e=>{e.preventDefault(); area.classList.add('dragover');}));
        ;['dragleave','drop'].forEach(ev=>area.addEventListener(ev,e=>{e.preventDefault(); if(ev==='drop'){const f=e.dataTransfer?.files?.[0]; if(f) { input.files=e.dataTransfer.files; this._handleFile(f,label);} } area.classList.remove('dragover'); }));
      }
      async _handleFile(file,which){ try{
        if(!file) return; if(!file.name.toLowerCase().endsWith('.csv')) throw new Error('Only .csv files are supported'); if(file.size>this.cfg.maxSize) throw new Error('File too large (max 10 MB)');
        this._info(which,`<strong>${escapeHtml(file.name)}</strong> • ${fileSize(file.size)}`,true);
        const text=await file.text(); const parsed=parseCSV(text,file.name); if(which==='old') this.old=parsed; else this.new=parsed; if(this.old && this.new) this._setupConfig();
      }catch(err){ alertBox('error',`Error processing ${file?.name||''}: ${err.message}`); this._info(which,'',false);} }
      _info(which,html,show){const el=$(which==='old'?'oldInfo':'newInfo'); el.style.display=show?'block':'none'; el.innerHTML=show?html:''}
      _setupConfig(){ const pk=$('pkSelect'), ts=$('tsSelect'); pk.innerHTML='<option value="">Select primary key…</option>'; ts.innerHTML='<option value="">Select timestamp…</option>';
        const common=this.old.headers.filter(h=>this.new.headers.includes(h)); if(common.length===0){alertBox('error','No common columns between the two CSVs.'); return;}
        common.forEach(h=>{ const o1=document.createElement('option');o1.value=h;o1.textContent=h; pk.appendChild(o1); const o2=document.createElement('option');o2.value=h;o2.textContent=h; ts.appendChild(o2);});
        // auto detect pk and timestamp
        const pkRe=/^(id|key|pk|primary.*key|.*_id|.*Id|.*ID)$/i; const tsRe=/^(date|time|timestamp|created.*at|updated.*at|.*_at|.*date|.*time)$/i;
        const pkGuess=common.find(h=>pkRe.test(h)); if(pkGuess) pk.value=pkGuess; const tsGuess=common.find(h=>tsRe.test(h)); if(tsGuess) ts.value=tsGuess;
        $('config').style.display='block';
      }
      async _go(){ try{
        const pk=$('pkSelect').value; const ts=$('tsSelect').value;
        if(!pk){ alertBox('error','Please select a primary key column.'); return; }
        $('loading').style.display='block'; $('results').style.display='none';
        // validation
        ensureUniquePK(this.old.data, pk, 'old dataset'); ensureUniquePK(this.new.data, pk, 'new dataset');
        this.result = diff(this.old,this.new,pk,ts||'');
        $('insCount').textContent=this.result.inserts.length; $('updCount').textContent=this.result.updates.length; $('delCount').textContent=this.result.deletes.length;
        $('results').style.display='block'; this._chart(); alertBox('success',`Diff generated successfully! Found ${this.result.inserts.length+this.result.updates.length+this.result.deletes.length} changes.`);
      }catch(err){ alertBox('error',`Error calculating diff: ${err.message}`);} finally{ $('loading').style.display='none'; } }
      _chart(){ const canvas=$('gantt'); if(this.chart) this.chart.cleanup(); this.chart=new Gantt(canvas,this.result,{onClick:(item)=>this._details(item)});
        if(this.resizeObs) this.resizeObs.disconnect(); this.resizeObs=new ResizeObserver(()=>this.chart?.resize()); this.resizeObs.observe(canvas.parentElement); }
      _details(item){ const drawer=$('drawer'), body=$('drawerBody');
        const ts = item.timestamp instanceof Date && !isNaN(item.timestamp) ? item.timestamp.toLocaleString() : (this.result.useOrdinalTime?`Position #${(item._ord??0)+1}`:'N/A');
        let html = `<div style="margin-bottom:10px"><strong>Type:</strong> <span style="font-weight:700;color:${item.type==='insert'?'var(--ins)':item.type==='update'?'var(--upd)':'var(--del)'}">${item.type.toUpperCase()}</span><br><strong>Primary Key:</strong> ${escapeHtml(item.key)}<br><strong>Timestamp:</strong> ${escapeHtml(ts)}</div>`;
        if(item.type==='update' && item.changes?.length){
          html += `<h4 style="margin:8px 0">Changes (${item.changes.length})</h4><table><thead><tr><th>Column</th><th>Old</th><th>New</th></tr></thead><tbody>`;
          item.changes.forEach(c=>{ html+=`<tr><td>${escapeHtml(c.column)}</td><td class="removed">${escapeHtml(c.oldValue??'')}</td><td class="added">${escapeHtml(c.newValue??'')}</td></tr>`; });
          html+='</tbody></table>';
        } else {
          const data = item.data || item.newData || item.oldData || {};
          html += `<h4 style="margin:8px 0">Row Data</h4><table><thead><tr><th>Column</th><th>Value</th></tr></thead><tbody>`;
          Object.entries(data).forEach(([k,v])=>{ const cls=item.type==='insert'?'added':'removed'; html+=`<tr><td>${escapeHtml(k)}</td><td class="${cls}">${escapeHtml(v??'')}</td></tr>`; });
          html+='</tbody></table>';
        }
        body.innerHTML = html; drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
      }
      _closeDrawer(){ const d=$('drawer'); d.classList.remove('open'); d.setAttribute('aria-hidden','true'); }
    }

    // bootstrap
    const app = new App();
    window.addEventListener('beforeunload',()=>{ app.chart?.cleanup(); app.resizeObs?.disconnect(); });
  })();
  </script>
</body>
</html>
